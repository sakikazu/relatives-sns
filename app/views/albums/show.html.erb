<script>
$(document).ready(function() {
  //uploadify
  $('#uploadify').uploadify({
    'swf' : '/assets/uploadify/uploadify.swf',
    'uploader' : '<%= album_photos_path(@album.id) %>',
    'formData' : {'user_id': <%= current_user.id %>},
    'queueID' : 'fileQueue',
    'auto' : true,
    'multi' : true,
    'buttonText' : 'ファイルを選択',
    //'buttonImg'      : '/_images/browse-files.png',
//    '_http_accept': 'text/html',  //406error対策とかあったらがやっぱエラーになった
    'onQueueComplete': function (evt, data){
      alert('ファイルのアップロードが完了しました。');
      location.reload();
      <%#= remote_function(:url => {:controller => :albums, :action => :upload_complete, :id => @album.id},
        :complete => "alert(\" ファイルのアップロードが完了しました。\");location.reload()")
        #:complete => "alert(data['filesUploaded']+\" ファイルのアップロードが完了しました。\");location.reload()")
      %>
    },

  });

  //colorbox
  colorbox_slideshow();

  // アルバム説明が長すぎたら開閉スイッチを挿入する
  var min_height = 200;
  var $desc = $('.description')
  var desc_height = $desc.height();
  if(desc_height > min_height) {
    $desc
      .height(min_height)
      .css({"overflow":"hidden"})
      .after('<div id="desc_open">＞＞続きを読む</div>');

    $('#desc_open')
      .css({
        'font-size':'16px',
        'color':'red',
        'font-weight':'bold',
        'cursor':'pointer'
      })
      .click(function(){
        if ($(this).data('open') == true ) {
          $(this).data('open', false);
          $desc.height(min_height);
          $(this).text('＞＞続きを読む');
        } else {
          $(this).data('open', true);
          $desc.height(desc_height);
          $(this).text('＞＞閉じる');
        }
      })
  }

  $.autopager({
    content: '.autopagerize_page_element', // コンテンツ部分のセレクタ 
    //次ページリンクのセレクタ(Default: 'a[rel=next]')
    //link   : '.next_page',  //デフォルトでいいのでコメントアウト 
    load: function(current, next) {
      var pageBreak = '<p>ページ: <a href="' + current.url + '">' + current.page + '</a></p>';
      //thisは読み込んだコンテンツ要素を指す
      $(this).before(pageBreak);
      //読み込んだページに再度colorboxを適用させる
      colorbox_slideshow();
    }
  });

}); //jquery#ready

commentshow = function() {
  $("#comment_area").toggle();
  if($("#showlink").text() == "表示") {
    $("#showlink").text("非表示");
  } else {
    $("#showlink").text("表示");
  }
}
</script>

<%= link_to 'アルバム一覧', albums_path, class: "btn" %>
<%= link_to '編集する', edit_album_path(@album), class: "btn btn-info" %>

<div class="page-header">
  <h3><%= "#{@album.title} （写真数：#{@photo_all_num}）" %></h3>
</div>

<div style="width:700px">
  <div class="once_content">
    <div class="info">
      作成者：<%= @album.user.try(:dispname) %> | 
      作成日時：<%= l @album.created_at if @album.created_at %>
    </div>
    <div class="description"><%= sani_custom_br(@album.description) %></div>
  </div>
</div>

<div class="page-header">
<h3>このアルバムへのコメント<span style="color:red;font-size:16px;margin-left:8px;">(<%= @album.album_comments.size %>)</span> / <%= link_to '表示', "javascript:commentshow();", {:id => 'showlink'} %></h3>
</div>
<div style="width:600px">
  <div id="comment_area" style="display:none">
    <div id="comments">
      <%= render "album_comments/comments" %>
    </div>

    <%= form_for([@album, @comment], :remote => true) do |f| %>
      <div class="field">
        <%= f.text_area :content, rows: 4, class: "span6" %>
      </div>
      <%= f.hidden_field :album_id %>
      <div class="actions">
        <%= f.submit "コメントする", class: "btn btn-primary" %>
      </div>
    <% end -%>
  </div>
</div>

<div class="page-header">
  <h3>写真をアップロードする<small>複数ファイル選択可能</small></h3>
</div>

<div id="fileQueue"></div>
<%= hidden_field_tag :user_id %>
<%= hidden_field_tag :album_id %>
<%= file_field_tag :uploadify %><br />

<% if @photos.size > 0 -%>
  <div class="page-header"><h3 class="normal">このアルバムの写真<small>写真をクリックするとスライドショーが開始されます</small></h3></div>
  <div class="select_menu clearfix">
    <% [["アップロード順", 1], ["撮影日時順", 2], ["コメント順", 3], ["イイネされた順", 4]].each do |n, i| -%>
      <% if @sort == i -%>
        <%= link_to n, album_path(:sort => i), class: "btn btn-danger" %>
      <% else -%>
        <%= link_to n, album_path(:sort => i), class: "btn" %>
      <% end -%>
    <% end -%>
  </div>
<% end -%>

<div class="autopagerize_page_element">
<div id="photo">
<%= paginate @photos, :window => 2, :outer_window => 2 %><br>
<% @photos.each do |p| -%>
  <div class="once_photo">
    <div class="bar">
      <%= "#{p.title} (コメント数：#{p.photo_comments.size}）" %>&nbsp;<%= nice_field_disp_only(p) %>
    </div>
    <div class="photo"><%= link_to(image_tag(p.image(:thumb)), slideshow_album_photo_path(@album, p), {rel: "colorbox"}) if p.image? %></div>
    <div class="info">
      投稿者：<%= p.user.try(:dispname) %><br />
      投稿日時：<%= l p.created_at if p.created_at %><br />
      撮影日時：<%= l p.exif_at if p.exif_at %><br />
      最新コメント日時：<%= l p.last_comment_at if p.last_comment_at %><br />

      <%= link_to '別ページで見る', album_photo_path(@album, p) %>
      <% if editable(current_user, p.user) -%>
        | <%= link_to '編集', edit_album_photo_path(@album, p) %>
        | <%= link_to '削除', album_photo_path(@album, p), :method => :delete, :confirm => '本当に削除してもよろしいですか？' %>
      <% end -%>
    </div>
  </div>
<% end -%>
<div class="clear"></div>
<%= paginate @photos, :window => 2, :outer_window => 2 %>
</div>
</div> <!-- autopagerize_page_element -->
