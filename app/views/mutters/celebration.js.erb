$('#background_black')
  .css({
    'display': 'block',
    'z-index': '100',
    'background-color': 'black',
    'opacity': '0.8',
    'cursor': 'pointer',
    'position': 'fixed',
    'overflow': 'hidden',
    'top':'0px',
    'left':'0px',
    'width':'100%',
    'height':'100%',
  })
  .click(function(){
    $(this).hide();
    $('.celebration_msg').remove();
  });

<% if @celeb_mutters.size > 0 -%>
  <% j = 0; toppoint = 0; -%>
  fontsize = 40;
  fontsize2 = 50;
  <% @celeb_mutters.each_with_index do |m, i| -%>
    $('#background_black')
      .after('<div id="celebration_msg<%= i %>" class="celebration_msg"><span class="name"><%= m.user.dispname(User::FULLNICK) %></span><br /><span class="moji"><%= auto_link(m.content.sub("\r\n", " ")).html_safe %></span></div>');
      //## 画像がうまく表示できない(image_tag)
      //sakikazu memo ここで「content」に改行（\r\n）が入っていたら、実際のJSで改行が入ってスクリプトエラーになった。これを事前に回避するの難しいな。。

    <%# j=0 if toppoint > 250 -%>
    <% j = rand(4) -%>
    <% toppoint = 20 + j * 120 -%>
    <%# j+=1 -%>
    $msg = $('#celebration_msg<%= i %>');
    //文字長に、フォントサイズをかけたものを、widthにする
    len_max = (len1 = $msg.find("span.moji").text().length) > (len2 = $msg.find("span.name").text().length) ? len1 : len2
    len = fontsize2 * (len_max);
    $msg
      .css({
        'position': 'fixed',
        'z-index': '101',
        'top':'<%= toppoint %>px',
        'left':$(window).width()+'px',
        'line-height': '70px',
        'width': len+'px',
      })
      .delay(<%= i*3000 %>)
      .animate({'left':'-'+len+'px', 'top':'<%= rand(500) %>'}, <%= 5000 + rand(10000) %>);
  <% end -%>

  $('.celebration_msg>.name').css({
    'color': 'white',
    'font-size': fontsize+'px',
  });

  $('.celebration_msg>.moji').css({
    'color': 'yellow',
    'font-size': fontsize2+'px',
  });

  //最後のメッセージのキューに、メッセージモードを終了させる処理を入れる
  $msg.queue(function(){
    $('#background_black').hide();
    $('.celebration_msg').remove();
  });

<% else -%>
  $('#background_black')
    .after('<div class="celebration_msg">まだお祝いなし。<br />本人でも祝えるよ＞＜</div>');
  $('.celebration_msg')
    .css({
      'position': 'fixed',
      'z-index': '101',
      'top':'150px',
      'right':'300px',
      'line-height': '70px',
      'font-size': '50px',
      'color': 'white',
    });
<% end -%>
